:80 {
    # Route API requests to backend with specific headers
    handle /api/* {
        reverse_proxy julekalender-backend:5000 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
        
        # Add cache control headers to prevent Cloudflare caching
        header Cache-Control "no-cache, no-store, must-revalidate"
        header Pragma "no-cache"
        header Expires "0"
    }
    
    # Route studio requests to Sanity Studio (optional - won't break if studio is down)
    handle /studio/* {
        reverse_proxy julekalender-studio:3333 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }
    
    # Route all other requests to frontend
    handle /* {
        reverse_proxy julekalender-frontend:80 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }
    
    # Enable compression
    encode gzip
}
